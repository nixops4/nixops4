<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Resource Provider Interface - NixOps4 Reference Manual</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../custom.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">NixOps4 Reference Manual</h1>

                    <div class="right-buttons">
                        <a href="https://github.com/nixops4/nixops4" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/nixops4/nixops4/tree/main/doc/manual/src/resource-provider/interface.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!--
  Context:
    - Concepts have already been outlined in ../concepts/resource.md
    - A generated schema reference documentation is available in
      - wrapper: schema/resource-v0.md
      - generated: doc/manual/src/schema/resource-schema-v0.gen.md
  Purpose of this page:
    - Describe the technical details of the interface transport
    - Provide a readable, high level description of the protocol, as the schema page is extremely verbose
    - "Link" the concepts to the schema
-->
<h1 id="resource-provider-interface"><a class="header" href="#resource-provider-interface">Resource Provider Interface</a></h1>
<p>Note that the resource provider interface is still in development.</p>
<p>The interface between a resource provider and NixOps consist of expectations about:</p>
<ul>
<li>The Nix expression that builds the provider and its output</li>
<li>The process that runs the provider</li>
<li>A JSON-lines protocol between the provider and NixOps</li>
</ul>
<h2 id="nix-expression"><a class="header" href="#nix-expression">Nix Expression</a></h2>
<p>Resource providers are defined as Nix modules that declare their resource types.
The provider module should include metadata for documentation generation and specify the resource types it supports.</p>
<p>For detailed information about all provider options, see the <a href="../modules/index.html#opt-providers">Provider Configuration Reference</a>.</p>
<p>For rendering provider documentation, see <a href="../lib/index.html#renderProviderDocs"><code>lib.renderProviderDocs</code></a>.</p>
<h2 id="process"><a class="header" href="#process">Process</a></h2>
<p>NixOps launches the resource provider process built in the previous step.</p>
<p>It communicates with the provider over the standard input and output streams using a JSON-lines protocol.
Standard error is used for logging, and is line-buffered.</p>
<p>Since the protocol is still in development, it is recommended to use the <a href="../architecture/nixops-components.html#nixops4-resource">../nixops4-resource crate</a>.</p>
<h2 id="protocol"><a class="header" href="#protocol">Protocol</a></h2>
<p>JSON-lines is a textual protocol where each line is a JSON value that is rendered without line breaks.
Each line must contain a single JSON value, and be terminated with a newline character.</p>
<p>We will refer to the JSON value that takes the line as a <em>message</em>.</p>
<p>Messages going from NixOps to the provider are <em>requests</em>, and messages going from the provider to NixOps are <em>responses</em>.</p>
<p>The content of the messages is specified in the <a href="../schema/resource-v0.html">resource schema</a>.</p>
<h3 id="message-flow"><a class="header" href="#message-flow">Message Flow</a></h3>
<p>Each request-response exchange follows this pattern:</p>
<ol>
<li>NixOps sends a single request message to the provider's stdin</li>
<li>The provider processes the request and sends a single response message to stdout</li>
</ol>
<p>The provider may write diagnostic messages to stderr at any time.</p>
<h3 id="request-and-response-structure"><a class="header" href="#request-and-response-structure">Request and Response Structure</a></h3>
<p>Both requests and responses use a wrapper object where the key indicates the message type (see <a href="../schema/resource-v0.html#1-property-request"><code>Request</code></a> and <a href="../schema/resource-v0.html#2-property-response"><code>Response</code></a>):</p>
<pre><code class="language-json">// Request
{
  "createResourceRequest": {
    "type": "memo",
    "inputProperties": { "initialize_with": "hello" },
    "isStateful": true
  }
}

// Response
{
  "createResourceResponse": {
    "outputProperties": { "value": "hello" }
  }
}
</code></pre>
<h3 id="operations"><a class="header" href="#operations">Operations</a></h3>
<p>The protocol supports the following operations:</p>
<p><strong>Create</strong>: Provisions a new resource. The request includes:</p>
<ul>
<li><code>type</code>: The resource type identifier</li>
<li><code>inputProperties</code>: Configuration values for the resource</li>
<li><code>isStateful</code>: Whether state persistence will be provided</li>
</ul>
<p>See <a href="../schema/resource-v0.html#11-property-createresourcerequest"><code>CreateResourceRequest</code></a> and <a href="../schema/resource-v0.html#21-property-createresourceresponse"><code>CreateResourceResponse</code></a> in the schema documentation.</p>
<p><strong>Update</strong>: Modifies an existing stateful resource. The request includes:</p>
<ul>
<li><code>resource</code>: The current resource state (type, input properties, and output properties)</li>
<li><code>inputProperties</code>: New configuration values</li>
</ul>
<p>See <a href="../schema/resource-v0.html#12-property-updateresourcerequest"><code>UpdateResourceRequest</code></a> and <a href="../schema/resource-v0.html#22-property-updateresourceresponse"><code>UpdateResourceResponse</code></a> in the schema documentation.</p>
<h3 id="state-operations"><a class="header" href="#state-operations">State Operations</a></h3>
<p>Resources that provide state storage implement additional operations:</p>
<p><strong>State Read</strong>: Retrieves the complete state managed by a state resource. The request includes:</p>
<ul>
<li><code>resource</code>: The state resource (type, input properties, and output properties)</li>
</ul>
<p>The response contains the full state as a JSON object representing all managed resources.</p>
<p><strong>State Event</strong>: Records a change event to the state. The request includes:</p>
<ul>
<li><code>resource</code>: The state resource</li>
<li><code>event</code>: The operation that produced this change (e.g., "create", "update", "destroy")</li>
<li><code>nixopsVersion</code>: The version of NixOps that produced this event</li>
<li><code>patch</code>: JSON Patch operations to apply to the state</li>
</ul>
<p>These operations use JSON Patch (<a href="https://tools.ietf.org/html/rfc6902">RFC 6902</a>) to track incremental state changes, enabling efficient state updates and historical tracking.</p>
<h3 id="state-persistence"><a class="header" href="#state-persistence">State Persistence</a></h3>
<p>The <code>isStateful</code> flag in create requests indicates whether the resource will have access to persistent state storage. Resource types that require state must validate this flag and fail if state persistence is not available.</p>
<p>State resources manage the persistence layer for stateful resources, providing operations to read the current state and record state changes as JSON Patch events.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../resource-provider/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../resource-provider/testing.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../resource-provider/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../resource-provider/testing.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>



    </div>
    </body>
</html>
